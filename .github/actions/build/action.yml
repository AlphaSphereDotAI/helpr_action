name: Build
description: Build Python package and upload artifacts
inputs:
  update_version:
    description: Whether to update the version to match the tag
    required: false
    default: 'true'
  target_version:
    description: Target version to set (defaults to tag name)
    required: false
outputs:
  package_version:
    description: The package version
    value: ${{ steps.get_package_version.outputs.result }}
runs:
  using: composite
  steps:
    - name: Checkout repository
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        token: ${{ secrets.GH_TOKEN }}

    - name: Get Package version from pyproject.toml
      id: get_package_version
      uses: mikefarah/yq@065b200af9851db0d5132f50bc10b1406ea5c0a8 # v4.50.1
      with:
        cmd: yq -roy '.project.version' pyproject.toml

    - name: Install uv
      uses: astral-sh/setup-uv@61cb8a9741eeb8a550a1b8544337180c0fc8476b # v7.2.0
      with:
        enable-cache: true
        activate-environment: true

    - name: Install the project
      run: uv sync --no-dev --frozen --no-editable
      shell: bash

    - name: Update Project Version
      if: ${{ inputs.update_version == 'true' && (inputs.target_version || github.ref_name) != steps.get_package_version.outputs.result }}
      run: uv version ${{ inputs.target_version || github.ref_name }}
      shell: bash

    - name: Build source and wheel distribution
      run: uv build
      shell: bash

    - name: Upload artifacts
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
      with:
        name: dist
        path: dist/

    - name: Update the main branch to the updated version
      if: ${{ inputs.update_version == 'true' && (inputs.target_version || github.ref_name) != steps.get_package_version.outputs.result }}
      uses: stefanzweifel/git-auto-commit-action@04702edda442b2e678b25b537cec683a1493fcb9 # v7.1.0
      with:
        commit_message: 'Version: ${{ inputs.target_version || github.ref_name }}'
        branch: main
        commit_options: --no-verify

    - name: Update the tag to the updated version
      if: ${{ inputs.update_version == 'true' && (inputs.target_version || github.ref_name) != steps.get_package_version.outputs.result }}
      run: |
        git tag --force ${{ inputs.target_version || github.ref_name }}
        git push origin --force HEAD:refs/tags/${{ inputs.target_version || github.ref_name }}
      shell: bash