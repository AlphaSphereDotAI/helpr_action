name: Test
description: Run tests and compatibility checks
inputs:
  test_command:
    description: Test command to run
    required: false
    default: "pytest"
  test_args:
    description: Additional test arguments
    required: false
    default: ""
outputs:
  dependency_check_status:
    description: Status of dependency compatibility check
    value: ${{ steps.dependency_check.outcome }}
runs:
  using: composite
  steps:
    - name: Install uv
      uses: astral-sh/setup-uv@61cb8a9741eeb8a550a1b8544337180c0fc8476b # v7.2.0
      with:
        enable-cache: true
        activate-environment: true

    - name: Install the project
      id: dependency_check
      run: uv sync --frozen --no-install-project
      shell: bash

    - name: Job Summary
      uses: jazanne/job-summary-action@690eb386a0b86fe4da7c6f0e543e61330ff09f06 # v1.0.0
      if: success() || failure()
      with:
        summary: |-
          ## Dependency Compatibility Check
            - **Status**: ${{ steps.dependency_check.outcome == 'success' && ':white_check_mark:' || ':x:' }}

    - name: Show Dependency Tree
      if: steps.dependency_check.outcome == 'success'
      run: |
        echo "## Dependency Tree" >> $GITHUB_STEP_SUMMARY
        echo "<details>" >> $GITHUB_STEP_SUMMARY
        echo "<summary> Dependency Tree </summary>" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "$(uv tree --show-sizes)" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "</details>" >> $GITHUB_STEP_SUMMARY
      shell: bash

    - name: Install test dependencies
      if: steps.dependency_check.outcome == 'success'
      run: uv sync --only-dev
      shell: bash

    - name: Run tests
      if: steps.dependency_check.outcome == 'success'
      run: ${{ inputs.test_command }} ${{ inputs.test_args }}
      shell: bash
      env:
        MERGIFY_TOKEN: ${{ secrets.MERGIFY_TOKEN }}
