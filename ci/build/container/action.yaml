name: Container Image
description: Build and push the container image to a registry
inputs:
  is_test:
    required: true
    description: Test Mode
  registry:
    required: true
    description: Registry
  install_source:
    required: true
    description: Source to install from (e.g., PyPI Package or Git source)
  github_token:
    required: false
    description: GitHub Token
  docker_token:
    required: false
    description: Docker Registry Token
outputs:
  image_tag:
    description: The built image tag
    value: ${{ steps.tag.outputs.TAG }}
  image_digest:
    description: The built image digest
    value: ${{ steps.push.outputs.digest }}
runs:
  using: composite
  steps:
    # check_dockerfile
    - name: Check Dockerfile
      uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
      id: dockerfile_lint
      with:
        call: check
    - name: Job Summary
      if: success() || failure()
      shell: bash
      run: |
        DOCKERFILE_STATUS="${{ steps.dockerfile_lint.outcome == 'success' && ':white_check_mark:' || ':x:' }}"
        echo '## Dockerfile Check' >> $GITHUB_STEP_SUMMARY
        echo '' >> $GITHUB_STEP_SUMMARY
        echo '- **Dockerfile Linting**' >> $GITHUB_STEP_SUMMARY
        echo '  - **Step Name**: Check Dockerfile' >> $GITHUB_STEP_SUMMARY
        echo '    - **Status**: $DOCKERFILE_STATUS' >> $GITHUB_STEP_SUMMARY
    # build_image
    - name: Free Disk Space
      uses: endersonmenezes/free-disk-space@e6ed9b02e683a3b55ed0252f1ee469ce3b39a885 # v3.1.0
      if: ${{ steps.dockerfile_lint.outcome == 'success' }}
      with:
        remove_android: true
        remove_dotnet: true
        remove_haskell: true
        remove_tool_cache: true
        remove_swap: true
        remove_packages_one_command: true
        rm_cmd: rmz
        remove_folders: >-
          /usr/share /usr/local/lib /usr/local/share /usr/local
    - name: Get Python version from pyproject.toml
      id: get_python_version
      uses: mikefarah/yq@065b200af9851db0d5132f50bc10b1406ea5c0a8 # v4.50.1
      with:
        cmd: yq -roy '.project.requires-python' pyproject.toml
    - name: Log in to ${{ inputs.registry }} Registry
      uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
      with:
        registry: ${{ inputs.registry }}
        username: mh0386
        password: >-
          ${{ inputs.registry == 'ghcr.io' && inputs.github_token || inputs.registry == 'docker.io' && inputs.docker_token }}
    - name: Set up QEMU
      uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3.7.0
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0
    - name: Docker meta
      id: meta
      uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5.10.0
      with:
        images: ${{ inputs.registry }}/${{ github.repository }}
        tags: |
          type=raw,value=latest,enable=${{ github.event_name == 'push' && contains(github.ref, 'refs/tags/') }}
          type=ref,event=pr,prefix={{sha}}-pr-
          type=ref,event=tag
          type=ref,event=branch
    - name: Build and Push to ${{ inputs.registry }}
      uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
      id: push
      with:
        push: true
        sbom: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        annotations: ${{ steps.meta.outputs.annotations }}
        build-args: |
          INSTALL_SOURCE=${{ inputs.install_source }}
          PYTHON_VERSION=${{ steps.get_python_version.outputs.result }}
      env:
        DOCKER_CONTENT_TRUST: '1'
    - name: Generate artifact attestation
      uses: actions/attest-build-provenance@96278af6caaf10aea03fd8d33a09a777ca52d62f # v3.2.0
      if: ${{ inputs.is_test == false }}
      with:
        subject-name: >-
          ${{inputs.registry == 'docker.io' && 'index.docker.io' || inputs.registry}}/${{github.repository}}
        subject-digest: ${{ steps.push.outputs.digest }}
        push-to-registry: true
    - name: Update Docker Hub Description
      if: ${{ inputs.registry == 'docker.io' }}
      uses: peter-evans/dockerhub-description@1b9a80c056b620d92cedb9d9b5a223409c68ddfa # v5.0.0
      with:
        username: mh0386
        password: ${{ inputs.docker_token }}
        repository: ${{ github.repository }}
        short-description: ${{ github.event.repository.description }}
        enable-url-completion: true
    - name: Export tag for Testing and Scanning
      id: tag
      shell: bash
      run: echo "TAG=$(echo "${{ steps.meta.outputs.tags }}" | tail -n 1)" >> $GITHUB_OUTPUT
