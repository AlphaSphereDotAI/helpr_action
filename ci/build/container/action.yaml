name: Container Image
description: Build and push the container image to a registry
inputs:
  is_test:
    required: true
    description: Test Mode
  registry:
    required: true
    description: Registry
  install_source:
    required: true
    description: Source to install from (e.g., PyPI Package or Git source)
  github_token:
    required: false
    description: GitHub Token
  docker_token:
    required: false
    description: Docker Registry Token
outputs:
  image_tag:
    description: The built image tag
    value: ${{ steps.tag.outputs.TAG }}
  image_digest:
    description: The built image digest
    value: ${{ steps.push.outputs.digest }}
runs:
  using: composite
  steps:
    # check_dockerfile
    - name: Check Dockerfile
      uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
      id: dockerfile_lint
      with:
        call: check
    - name: Job Summary
      uses: jazanne/job-summary-action@690eb386a0b86fe4da7c6f0e543e61330ff09f06 # v1.0.0
      if: success() || failure()
      with:
        summary: |-
          ## Dockerfile Check
          - **Status**: ${{ steps.dockerfile_lint.outcome == 'success' && ':white_check_mark:' || ':x:' }}
    # build_image
    - name: Free Disk Space
      uses: endersonmenezes/free-disk-space@e6ed9b02e683a3b55ed0252f1ee469ce3b39a885 # v3.1.0
      if: ${{ steps.dockerfile_lint.outcome == 'success' }}
      with:
        remove_android: true
        remove_dotnet: true
        remove_haskell: true
        remove_tool_cache: true
        remove_swap: true
        remove_packages_one_command: true
        rm_cmd: rmz
        remove_folders: >-
          /usr/share /usr/local/lib /usr/local/share /usr/local
    - name: Get Python version from pyproject.toml
      id: get_python_version
      uses: mikefarah/yq@065b200af9851db0d5132f50bc10b1406ea5c0a8 # v4.50.1
      with:
        cmd: yq -roy '.project.requires-python' pyproject.toml
    - name: Log in to ${{ inputs.registry }} Registry
      uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
      with:
        registry: ${{ inputs.registry }}
        username: mh0386
        password: >-
          ${{

            inputs.registry == 'ghcr.io' && inputs.github_token ||
            inputs.registry == 'docker.io' && inputs.docker_token
          }}
    - name: Set up QEMU
      uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3.7.0
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0
    - name: Docker meta
      id: meta
      uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5.10.0
      with:
        images: ${{ inputs.registry }}/${{ github.repository }}
        tags: |
          type=raw,value=latest,enable=${{ github.event_name == 'push' && contains(github.ref, 'refs/tags/') }}
          type=ref,event=pr,prefix={{sha}}-pr-
          type=ref,event=tag
          type=ref,event=branch
    - name: Build and Push to ${{ inputs.registry }}
      uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
      id: push
      with:
        push: true
        sbom: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        annotations: ${{ steps.meta.outputs.annotations }}
        build-args: |
          INSTALL_SOURCE=${{ inputs.install_source }}
          PYTHON_VERSION=${{ steps.get_python_version.outputs.result }}
      env:
        DOCKER_CONTENT_TRUST: "1"
    - name: Generate artifact attestation
      uses: actions/attest-build-provenance@00014ed6ed5efc5b1ab7f7f34a39eb55d41aa4f8 # v3.1.0
      if: ${{ inputs.is_test == false }}
      with:
        subject-name: >-
          ${{

            inputs.registry == 'docker.io' && 'index.docker.io' || inputs.registry
          }}/${{github.repository}}
        subject-digest: ${{ steps.push.outputs.digest }}
        push-to-registry: true
    - name: Update Docker Hub Description
      if: ${{ inputs.registry == 'docker.io' }}
      uses: peter-evans/dockerhub-description@1b9a80c056b620d92cedb9d9b5a223409c68ddfa # v5.0.0
      with:
        username: mh0386
        password: ${{ inputs.docker_token }}
        repository: ${{ github.repository }}
        short-description: ${{ github.event.repository.description }}
        enable-url-completion: true
    - name: Export tag for Testing and Scanning
      id: tag
      shell: bash
      run: echo "TAG=$(echo "${{ steps.meta.outputs.tags }}" | tail -n 1)" >> $GITHUB_OUTPUT
    # docker_scout
    - name: Docker Scout
      uses: docker/scout-action@f8c776824083494ab0d56b8105ba2ca85c86e4de # v1.18.2
      with:
        command: cves
        dockerhub-user: mh0386
        dockerhub-password: ${{ inputs.docker_token }}
        image: ${{ steps.tag.outputs.TAG }}
        github-token: ${{ inputs.github_token }}
    # trufflehog
    - name: Install trufflehog
      uses: jaxxstorm/action-install-gh-release@6096f2a2bbfee498ced520b6922ac2c06e990ed2 # v2.1.0
      with:
        repo: trufflesecurity/trufflehog
        cache: enable
    - name: Docker Secret Scanning
      shell: bash
      run: >-
        trufflehog docker --image ${{steps.tag.outputs.TAG}} --fail --github-actions --results=verified --log-level=4 --no-update
    # syft
    - name: SBOM Generation
      uses: anchore/sbom-action@0b82b0b1a22399a1c542d4d656f70cd903571b5c # v0.21.1
      with:
        image: ${{ steps.tag.outputs.TAG }}
        dependency-snapshot: true
        output-file: ${{ github.event.repository.name }}-sbom.json
        format: syft-json
    # grype
    - name: Scan image
      uses: anchore/scan-action@62b74fb7bb810d2c45b1865f47a77655621862a5 # v7.2.3
      id: scan
      with:
        image: ${{ steps.tag.outputs.TAG }}
        cache-db: true
    - name: upload Anchore scan SARIF report
      if: success() || failure()
      uses: github/codeql-action/upload-sarif@cdefb33c0f6224e58673d9004f47f7cb3e328b89 # v4.31.10
      with:
        sarif_file: ${{ steps.scan.outputs.sarif }}
    # trivy
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # 0.33.1
      with:
        image-ref: ${{ steps.tag.outputs.TAG }}
        trivy-config: .github/lint/.trivy.yaml
        format: sarif
        output: trivy-results-image.sarif
        exit-code: "1"
        scanners: vuln,secret,misconfig,license
    - name: Upload Trivy scan results to GitHub Security tab
      if: success() || failure()
      uses: github/codeql-action/upload-sarif@cdefb33c0f6224e58673d9004f47f7cb3e328b89 # v4.31.10
      with:
        sarif_file: trivy-results-image.sarif
    # dockle
    - name: Lint the Container Image
      uses: goodwithtech/dockle-action@e30e6af832aad6ea7dca2a248d31a85eab6dbd68 # v0.4.15
      with:
        image: ${{ steps.tag.outputs.TAG }}
        format: sarif
        output: dockle.sarif
        accept-file: settings.py
        accept-key: --chmod,--chown,GRADIO_SERVER_PORT,GRADIO_SERVER_NAME,FASTEMBED_CACHE_PATH,PATH
        ignore: CIS-DI-0006
    - name: upload Dockle scan SARIF report
      if: success() || failure()
      uses: github/codeql-action/upload-sarif@cdefb33c0f6224e58673d9004f47f7cb3e328b89 # v4.31.10
      with:
        sarif_file: dockle.sarif
